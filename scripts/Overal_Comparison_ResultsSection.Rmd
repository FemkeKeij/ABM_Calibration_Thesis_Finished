---
title: "Overall_Comparison_ResultsSection"
author: "Femke Keij S2647168"
date: "2024-02-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preliminary
Clear working directory & set random seed:
```{r}
rm(list = ls(all = TRUE))

set.seed(42)
```

Packages used:
```{r}
# for importing / working with tidy data
library(tidyverse)

# for colour palettes
library(RColorBrewer)

# for composite plots
library(patchwork)
```

# Data
Read in the error data frames for both the Fire & Wolf-Sheep Predation ABMs.
```{r}
# fire ABM
fire_lr_errors <- read_csv('data/results/fire_lr_errors.csv')
fire_pls_errors <- read_csv('data/results/fire_pls_errors.csv')
fire_rf_errors <- read_csv('data/results/fire_rf_errors.csv')
fire_mrf_errors <- read_csv('data/results/fire_mrf_errors.csv')

# Wolf Sheep Predation ABM
ws_lr_errors <- read_csv('data/results/wolfsheep_LR_errors.csv')
ws_pls_errors <- read_csv('data/results/wolfsheep_PLS_errors.csv')
ws_rf_errors <- read_csv('data/results/wolfsheep_rf_errors.csv')
ws_mrf_errors <- read_csv('data/results/wolfsheep_mrf_errors.csv')
```

Merge data:
```{r}
# change to a metric, entity, value format to enable merging with ws data
errors_fire <- bind_rows(fire_lr_errors, fire_pls_errors,
                         fire_rf_errors, fire_mrf_errors) %>%
  mutate(ABM = 'fire') %>%
  rename('perccorrect_all' = 'perc_correct_params',
         'perccorrect_density' = 'perc_density_correct',
         'perccorrect_density_cat' = 'perc_correct_cat_density',
         'perccorrect_directions' = 'perc_directions_correct',
         'ppp_density' = 'point_pred_performance_density',
         'kappa_directions' = 'directions_kappa',
         'F1_directions' = 'directions_f1',
         'MCC_directions' = 'directions_mcc') %>%
  pivot_longer(cols = c('perccorrect_all',
                        'perccorrect_density',
                        'perccorrect_density_cat',
                        'perccorrect_directions',
                        'RMSE_density',
                        'NRMSE_density',
                        'ppp_density',
                        'kappa_directions',
                        'F1_directions',
                        'MCC_directions'),
               names_to = 'metric',
               values_to = 'value') %>%
  rowwise %>%
  mutate(new_metric = str_split(metric, '_', 2)[[1]][1],
         entity = str_split(metric, '_', 2)[[1]][2]) %>%
  select(- metric) %>%
  rename(metric = new_metric)

# change to a metric, entity, value format to enable merging with fire data
errors_ws <- bind_rows(ws_lr_errors, ws_pls_errors,
                       ws_rf_errors, ws_mrf_errors) %>%
  mutate(ABM = 'wolf sheep predation') %>%
  rename('perccorrect_all' = "perc_correct_params",
         'perccorrect_initial_sheep' = "perc_initial_sheep_correct",
         'perccorrect_initial_wolves' = "perc_initial_wolves_correct",
         'perccorrect_sheep_food' = "perc_food_sheep_correct",
         'perccorrect_wolves_food' = "perc_food_wolves_correct",
         'perccorrect_sheep_rep' = "perc_sheep_rep_correct",
         'perccorrect_wolves_rep' = "perc_wolves_rep_correct",
         'perccorrect_grass' = "perc_grass_correct",
         'RMSE_initial_sheep' = "RMSE_initial_sheep",
         'RMSE_initial_wolves' = "RMSE_initial_wolves",
         'RMSE_sheep_food' = "RMSE_food_sheep",
         'RMSE_wolves_food' = "RMSE_food_wolves",
         'RMSE_sheep_rep' = "RMSE_sheep_rep",
         'RMSE_wolves_rep' = "RMSE_wolves_rep",
         'RMSE_grass' = "RMSE_grass",  
         'NRMSE_initial_sheep' = "NRMSE_initial_sheep",
         'NRMSE_initial_wolves' = "NRMSE_initial_wolves",
         'NRMSE_sheep_food' = "NRMSE_food_sheep",
         'NRMSE_wolves_food' = "NRMSE_food_wolves",
         'NRMSE_sheep_rep' = "NRMSE_sheep_rep",
         'NRMSE_wolves_rep' = "NRMSE_wolves_rep",
         'NRMSE_grass' = "NRMSE_grass",
         'ppp_initial_sheep' = "ppp_initial_sheep",
         'ppp_initial_wolves' = "ppp_initial_wolves",
         'ppp_sheep_food' = "ppp_food_sheep",
         'ppp_wolves_food' = "ppp_food_wolves",
         'ppp_sheep_rep' = "ppp_sheep_rep",
         'ppp_wolves_rep' = "ppp_wolves_rep",
         'ppp_grass' = "ppp_grass") %>%
  pivot_longer(cols = c('perccorrect_all',
         'perccorrect_initial_sheep',
         'perccorrect_initial_wolves',
         'perccorrect_sheep_food',
         'perccorrect_wolves_food',
         'perccorrect_sheep_rep',
         'perccorrect_wolves_rep',
         'perccorrect_grass',
         'RMSE_initial_sheep',
         'RMSE_initial_wolves',
         'RMSE_sheep_food',
         'RMSE_wolves_food',
         'RMSE_sheep_rep',
         'RMSE_wolves_rep',
         'RMSE_grass',  
         'NRMSE_initial_sheep',
         'NRMSE_initial_wolves',
         'NRMSE_sheep_food',
         'NRMSE_wolves_food',
         'NRMSE_sheep_rep',
         'NRMSE_wolves_rep',
         'NRMSE_grass',
         'ppp_initial_sheep',
         'ppp_initial_wolves',
         'ppp_sheep_food',
         'ppp_wolves_food',
         'ppp_sheep_rep',
         'ppp_wolves_rep',
         'ppp_grass'),
               names_to = 'metric',
               values_to = 'value') %>%
  rowwise %>%
  mutate(new_metric = str_split(metric, '_', 2)[[1]][1],
         entity = str_split(metric, '_', 2)[[1]][2]) %>%
  select(- metric) %>%
  rename(metric = new_metric)

# merge data frames
errors <- bind_rows(errors_fire, errors_ws) %>%
  mutate(datapoints = ifelse(datapoints == 'timepoints', 
                             'mid and endpoint', datapoints)) %>%
  filter(metric != 'RMSE') %>%
  filter(metric != 'perccorrect' & entity != 'all') %>%
  mutate(algorithm = ifelse(algorithm == 'PLS',
                            'Partial Least Squares',
                            algorithm))
```

# Compare fire to w-s
```{r}
errors %>%
  ggplot(mapping = aes(x = ABM,
                       y = value)) +
  geom_boxplot() +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90)) +
  labs(x = NULL) +
  scale_fill_brewer(palette = 'Set2')

ggsave('figures/results_comparison.pdf',
       height = 10, width = 20, unit = 'cm')
```

# RQ1: The influence of data choices on calibration performance
One figure comparing all (for poster):
```{r}
metric_labels <- c('perccorrect' = '% correctly estimated parameters',
                   'NRMSE' = 'NRMSE',
                   'ppp' = 'point predictive performance',
                   'kappa' = 'kappa score',
                   'F1' = 'F1 score',
                   'MCC' = 'MCC')

one_fire <- errors %>%
  filter(ABM == 'fire') %>%
  ggplot(mapping = aes(x = fct_relevel(summarise_runs,
                                       'full',
                                       'summarised'),
                       y = value)) +
  geom_boxplot(aes(fill = interaction(noise, datapoints)),
               outlier.colour = 'transparent',
               alpha = 0.5) +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Fire',
       fill = 'noise & data points') +
  scale_fill_brewer(palette = 'Set2')

one_ws <- errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  filter(datapoints %in% 
           c('endpoints', 'timesteps 20', 'timeseries')) %>%
  ggplot(mapping = aes(x = fct_relevel(summarise_runs,
                                       'full',
                                       'summarised'),
                       y = value)) +
  geom_boxplot(aes(fill = fct_relevel(datapoints,
                                      'endpoints',
                                      'timesteps 20',
                                      'timeseries')),
               outlier.colour = 'transparent',
               alpha = 0.5) +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0, height = 0, alpha = 0.5) +
  facet_wrap(metric ~ noise, scales = 'free_y', ncol = 3,
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Wolf Sheep Predation',
       fill = 'data points') +
  scale_fill_brewer(palette = 'Set2')

one_fire / one_ws +
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = 'collect',
              heights = c(2, 2)) &
  theme_minimal() &
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90))

ggsave('figures/results_q1.pdf',
       height = 35, width = 25, unit = 'cm')
```
## 1a. Time series vs. time points
Plot:
```{r}
metric_labels <- c('perccorrect' = '% correctly estimated parameters',
                   'NRMSE' = 'NRMSE',
                   'ppp' = 'point predictive performance',
                   'kappa' = 'kappa score',
                   'F1' = 'F1 score',
                   'MCC' = 'MCC')

one_a_fire <- errors %>%
  filter(ABM == 'fire') %>%
  ggplot(mapping = aes(x = fct_relevel(datapoints,
                                       'endpoints',
                                       'mid and endpoint'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Fire') +
  scale_fill_brewer(palette = 'Set2')

one_a_ws <- errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  ggplot(mapping = aes(x = fct_relevel(datapoints,
                                       'endpoints',
                                       'timesteps 50',
                                       'timesteps 20',
                                       'timesteps 10',
                                       'timeseries'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Wolf Sheep Predation') +
  scale_fill_brewer(palette = 'Set2')

one_a_fire / one_a_ws +
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = 'collect',
              heights = c(2, 1)) &
  theme_minimal() &
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90))

ggsave('figures/results_q1a.pdf',
       height = 25, width = 25, unit = 'cm')
```

Computations:
```{r}
errors %>%
  filter(ABM == 'fire') %>%
  group_by(metric, datapoints) %>%
  summarise(mean = mean(value),
            sd = sd(value))

errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  group_by(metric, datapoints) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

# excluding LR & PLS for WS
errors %>%
  filter(ABM == 'wolf sheep predation',
         algorithm %in% c('Random Forest',
                          'Multivariate Random Forest')) %>%
  group_by(metric, datapoints) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```

## 1b. Summarising repeated runs of the same parameter combination
Plot:
```{r}
one_b_fire <- errors %>%
  filter(ABM == 'fire') %>%
  ggplot(mapping = aes(x = fct_relevel(summarise_runs,
                                       'full',
                                       'summarised'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'agorithm',
       subtitle = 'Fire') +
  scale_fill_brewer(palette = 'Set2')

one_b_ws <- errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  ggplot(mapping = aes(x = fct_relevel(summarise_runs,
                                       'full',
                                       'summarised'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'agorithm',
       subtitle = 'Wolf Sheep Predation') +
  scale_fill_brewer(palette = 'Set2')

one_b_fire / one_b_ws +
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = 'collect',
              heights = c(2, 1)) &
  theme_minimal() &
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90))

ggsave('figures/results_q1b.pdf',
       height = 25, width = 25, unit = 'cm')
```

Computations:
```{r}
errors %>%
  filter(ABM == 'fire') %>%
  group_by(metric, summarise_runs) %>%
  summarise(mean = mean(value),
            sd = sd(value))

errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  group_by(metric, summarise_runs) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

errors %>%
  filter(algorithm %in% c('Random Forest', 'Multivariate Random Forest'),
         ABM == 'wolf sheep predation') %>%
  group_by(metric, summarise_runs) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```

## 1c. Noise in the test data
Plot:
```{r}
one_c_fire <- errors %>%
  filter(ABM == 'fire') %>%
  mutate(noise = ifelse(noise == 'noise', 'output noise',
                        noise)) %>%
  ggplot(mapping = aes(x = fct_relevel(noise,
                                       'clean',
                                       'output noise'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Fire') +
  scale_fill_brewer(palette = 'Set2')

one_c_ws <- errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  mutate(noise = ifelse(noise == 'noise', 'output noise',
                        noise)) %>%
  ggplot(mapping = aes(x = fct_relevel(noise,
                                       'clean',
                                       'output noise',
                                       'double noise'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Wolf Sheep Predation') +
  scale_fill_brewer(palette = 'Set2')

one_c_fire / one_c_ws +
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = 'collect',
              heights = c(2, 1)) &
  theme_minimal() &
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90))

ggsave('figures/results_q1c.pdf',
       height = 25, width = 25, unit = 'cm')
```

Computations:
```{r}
errors %>%
  filter(ABM == 'fire') %>%
  group_by(metric, noise) %>%
  summarise(mean = mean(value),
            sd = sd(value))

errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  group_by(metric, noise) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

# excluding LR & PLS for WS
errors %>%
  filter(algorithm %in% c('Random Forest', 'Multivariate Random Forest'),
         ABM == 'wolf sheep predation') %>%
  group_by(metric, noise) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```

# RQ2: A comparison of different calibration algorithms
All 3 subquestions can be answered using just 1 figure:
## 2a. Univariate vs. multivariate approaches
## 2b. Linear vs. non-linear approaches
## 2c. Which algorithm performs best?
Plot:
```{r}
two_fire <- errors %>%
  filter(ABM == 'fire') %>%
  ggplot(mapping = aes(x = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(summarise_runs,
                                       'full',
                                       'summarised')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Fire') +
  scale_fill_brewer(palette = 'Set2')

two_ws <- errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  ggplot(mapping = aes(x = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest'),
                       y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(summarise_runs,
                                       'full',
                                       'summarised')),
              width = 0.15, height = 0, alpha = 0.5) +
  facet_wrap(~ metric, scales = 'free_y',
             labeller = labeller(metric = metric_labels)) +
  labs(x = NULL,
       colour = 'algorithm',
       subtitle = 'Wolf Sheep Predation') +
  scale_fill_brewer(palette = 'Set2')

two_fire / two_ws +
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = 'collect',
              heights = c(2, 1)) &
  theme_minimal() &
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90))

ggsave('figures/results_q2.pdf',
       height = 25, width = 25, unit = 'cm')
```

Computations:
```{r}
errors %>%
  filter(ABM == 'fire') %>%
  group_by(metric, algorithm) %>%
  summarise(mean = mean(value),
            sd = sd(value))

errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  group_by(metric, algorithm) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```

Computations:
```{r}
errors %>%
  filter(ABM == 'fire') %>%
  group_by(metric, algorithm) %>%
  summarise(max = max(value),
            min = min(value))

errors %>%
  filter(ABM == 'wolf sheep predation') %>%
  group_by(metric, algorithm) %>%
  summarise(max = max(value, na.rm = TRUE),
            min = min(value, na.rm = TRUE))
```

# Observations
% Correctly estimated parameters:
(had to re-run the data to include the percentage correct parameters)
```{r}
perc_fire <- errors %>%
  mutate(algorithm = ifelse(algorithm == 'PLS',
                            'Partial Least Squares',
                            algorithm)) %>%
  filter(entity %in% c('density', 'directions'),
         metric == 'perccorrect') %>%
  ggplot(mapping = aes(x = entity, y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.15, height = 0, alpha = 0.5) +
  labs(x = NULL,
       y = '% correctly estimated',
       colour = 'algorithm',
       subtitle = 'Fire') +
  theme(legend.position = 'none')

perc_ws <- errors %>%
  mutate(algorithm = ifelse(algorithm == 'PLS',
                          'Partial Least Squares',
                          algorithm)) %>%
  filter(entity != 'all',
         metric == 'perccorrect',
         ABM == 'wolf sheep predation') %>%
  ggplot(mapping = aes(x = entity, y = value)) +
  geom_boxplot(outlier.colour = 'transparent') +
  geom_jitter(aes(colour = fct_relevel(algorithm,
                                       'Linear Regression',
                                       'Partial Least Squares',
                                       'Random Forest',
                                       'Multivariate Random Forest')),
              width = 0.2, height = 0, alpha = 0.7) +
  labs(x = NULL,
       y = '% correctly estimated',
       colour = NULL,
       subtitle = 'Wolf Sheep Predation') +
  scale_x_discrete(labels = c('grass regrowth \n time',
                              'initial number \n of sheep',
                              'initial number \n of wolves',
                              'sheep gain \n from food',
                              'sheep reproductive \n probability',
                              'wolves gain \n from food',
                              'wolves reproductive \n probability')) +
  theme(legend.position = 'none')

perc_fire / perc_ws +
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = 'collect') &
  theme_minimal() &
  theme(panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA,
                                    colour = 'lightgrey'),
        axis.text.x = element_text(angle = 90))

ggsave('figures/results_percentages.pdf',
       height = 15, width = 20, unit = 'cm')
```